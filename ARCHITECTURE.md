# Architecture

Roomtone is a single-room call with backend-only media over WebSocket by default. Each browser connects to the server over WebSocket for signaling and media fan-out. A WebRTC mesh mode remains available when `MEDIA_TRANSPORT=webrtc`.

## Components

- Browser UI (React + TypeScript)
- Signaling server (Node.js + Express + ws)
- Optional Telegram bot (JWT invite issuer)
- Optional notification paths (browser notifications + Telegram join notices)

## Data Flow

```
+-----------+          WebSocket           +-----------------+
|  Browser  |  <------------------------>  |  Node Signaling |
+-----------+   (signaling + media)        +-----------------+
      |                                               |
      |             Media fan-out (WS)                |
      +-----------------+-----------------------------+
                        |
                +---------------+
                |  Other peers  |
                +---------------+
```

In `MEDIA_TRANSPORT=ws`, media is recorded into chunks and streamed over WSS.
In `MEDIA_TRANSPORT=webrtc`, media flows directly between peers using ICE.

## Optional Bot Flow

The Telegram bot is a separate process that signs short-lived JWT invite links
for allowlisted Telegram users. The browser loads the link, which provides the
token to the server for authentication.

When join notifications are enabled, the bot periodically polls the server's
`/participants` endpoint and posts a short message (with a compact join link)
to configured chats.

## Signaling Messages

All clients join the same room. The server tracks participant IDs and forwards signaling payloads.

- `join` -> client sends name, server responds with `welcome`.
- `peer-joined` -> server notifies existing peers to create offers.
- `signal` -> clients exchange SDP offers/answers and ICE candidates.
- `media-start` -> client announces media MIME type for WebSocket streaming.
- `media-stop` -> client stops WebSocket media streaming.
- Binary frames -> media chunks wrapped with a small peer ID header.
- `peer-left` -> server notifies peers to clean up.

## Room Model

There is exactly one room. Participant IDs are generated by the server. Names are provided by the client and limited to 40 characters.

## Scaling Notes

With `MEDIA_TRANSPORT=ws`, the server fans out media to every participant. This
increases backend CPU and bandwidth usage linearly with room size. With
`MEDIA_TRANSPORT=webrtc`, clients connect directly to every other participant;
larger rooms would require an SFU.
