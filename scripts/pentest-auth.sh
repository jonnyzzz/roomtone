#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
PORT="${PORT:-5670}"
BASE_URL="${BASE_URL:-http://127.0.0.1:${PORT}}"
ZAP_IMAGE="${ZAP_IMAGE:-owasp/zap2docker-stable}"
ZAP_REPORT_DIR="${ZAP_REPORT_DIR:-${ROOT_DIR}/pentest}"
ZAP_NETWORK="${ZAP_NETWORK:-host}"
ZAP_TARGET="${ZAP_TARGET:-${BASE_URL}}"

mkdir -p "${ZAP_REPORT_DIR}"

TMP_DIR="$(mktemp -d)"
SERVER_PID=""

cleanup() {
  if [[ -n "${SERVER_PID}" ]]; then
    kill "${SERVER_PID}" >/dev/null 2>&1 || true
    wait "${SERVER_PID}" >/dev/null 2>&1 || true
  fi
  rm -rf "${TMP_DIR}"
}

trap cleanup EXIT

node "${ROOT_DIR}/scripts/pentest/generate-auth.mjs" "${TMP_DIR}"
AUTH_PUBLIC_KEYS="$(cat "${TMP_DIR}/public.pem")"
AUTH_TOKEN="$(cat "${TMP_DIR}/token.txt")"

if [[ ! -f "${ROOT_DIR}/dist/server/index.js" ]]; then
  npm run build
fi

AUTH_ENABLED="true" \
AUTH_PUBLIC_KEYS="${AUTH_PUBLIC_KEYS}" \
ALLOW_INSECURE_HTTP="true" \
PORT="${PORT}" \
node "${ROOT_DIR}/dist/server/index.js" \
  >"${ZAP_REPORT_DIR}/server.log" 2>&1 &
SERVER_PID=$!

health_url="${BASE_URL}/health?token=${AUTH_TOKEN}"
for _ in $(seq 1 60); do
  if node -e "fetch(process.argv[1]).then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))" "${health_url}"; then
    break
  fi
  sleep 0.5
done

node "${ROOT_DIR}/scripts/pentest/auth-preflight.mjs" "${BASE_URL}" "${AUTH_TOKEN}"

if [[ "${ZAP_NETWORK}" != "host" ]]; then
  ZAP_TARGET="${ZAP_TARGET/127.0.0.1/host.docker.internal}"
  ZAP_TARGET="${ZAP_TARGET/localhost/host.docker.internal}"
  ZAP_TARGET="${ZAP_TARGET/0.0.0.0/host.docker.internal}"
fi

ENCODED_TOKEN="$(node -p "encodeURIComponent(process.argv[1])" "${AUTH_TOKEN}")"
SCAN_TARGET="${ZAP_TARGET}/?token=${ENCODED_TOKEN}"

docker run --rm -t \
  --network "${ZAP_NETWORK}" \
  -v "${ZAP_REPORT_DIR}:/zap/wrk" \
  "${ZAP_IMAGE}" \
  zap-baseline.py -t "${SCAN_TARGET}" -r zap-report.html -J zap-report.json
