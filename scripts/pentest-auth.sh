#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
PORT="${PORT:-5670}"
BASE_URL="${BASE_URL:-http://127.0.0.1:${PORT}}"
ZAP_IMAGE="${ZAP_IMAGE:-ghcr.io/zaproxy/zaproxy:stable}"
ZAP_REPORT_DIR="${ZAP_REPORT_DIR:-${ROOT_DIR}/pentest}"
ZAP_NETWORK="${ZAP_NETWORK:-host}"
ZAP_TARGET="${ZAP_TARGET:-${BASE_URL}}"
ZAP_BASELINE_ARGS=()
if [[ "${CI:-}" == "true" ]]; then
  ZAP_BASELINE_ARGS+=("-I")
fi

mkdir -p "${ZAP_REPORT_DIR}"
chmod 777 "${ZAP_REPORT_DIR}" || true

TMP_DIR="$(mktemp -d)"
SERVER_PID=""

cleanup() {
  if [[ -n "${SERVER_PID}" ]]; then
    kill "${SERVER_PID}" >/dev/null 2>&1 || true
    wait "${SERVER_PID}" >/dev/null 2>&1 || true
  fi
  rm -rf "${TMP_DIR}"
}

trap cleanup EXIT

node "${ROOT_DIR}/scripts/pentest/generate-auth.mjs" "${TMP_DIR}"
AUTH_PUBLIC_KEYS="$(cat "${TMP_DIR}/public.pem")"
AUTH_TOKEN="$(cat "${TMP_DIR}/token.txt")"

if [[ ! -f "${ROOT_DIR}/dist/server/index.js" ]]; then
  npm run build
fi

AUTH_ENABLED="true" \
AUTH_PUBLIC_KEYS="${AUTH_PUBLIC_KEYS}" \
ALLOW_INSECURE_HTTP="true" \
PORT="${PORT}" \
node "${ROOT_DIR}/dist/server/index.js" \
  >"${ZAP_REPORT_DIR}/server.log" 2>&1 &
SERVER_PID=$!

health_url="${BASE_URL}/health"
health_ok=false
for _ in $(seq 1 60); do
  if node -e "fetch(process.argv[1]).then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))" "${health_url}"; then
    health_ok=true
    break
  fi
  sleep 0.5
done
if [[ "${health_ok}" != "true" ]]; then
  echo "Server failed to become healthy at ${health_url}."
  exit 1
fi

AUTH_COOKIE_FILE="${TMP_DIR}/auth-cookie.txt"
node "${ROOT_DIR}/scripts/pentest/auth-preflight.mjs" \
  "${BASE_URL}" \
  "${AUTH_TOKEN}" \
  "${AUTH_COOKIE_FILE}"
AUTH_COOKIE="$(cat "${AUTH_COOKIE_FILE}")"
if [[ -z "${AUTH_COOKIE}" ]]; then
  echo "Auth cookie was not produced by auth-preflight."
  exit 1
fi

if [[ "${ZAP_NETWORK}" != "host" ]]; then
  ZAP_TARGET="${ZAP_TARGET/127.0.0.1/host.docker.internal}"
  ZAP_TARGET="${ZAP_TARGET/localhost/host.docker.internal}"
  ZAP_TARGET="${ZAP_TARGET/0.0.0.0/host.docker.internal}"
fi

SCAN_TARGET="${ZAP_TARGET}/"
ZAP_AUTH_CONFIG=$(printf "%s " \
  "-config" "replacer.full_list(0).description=roomtone-cookie" \
  "-config" "replacer.full_list(0).enabled=true" \
  "-config" "replacer.full_list(0).matchtype=REQ_HEADER" \
  "-config" "replacer.full_list(0).matchstr=Cookie" \
  "-config" "replacer.full_list(0).replacement=${AUTH_COOKIE}" \
  "-config" "replacer.full_list(0).initiators=1,2,3,4,5,6,7,8,9")

docker run --rm -t \
  --network "${ZAP_NETWORK}" \
  -v "${ZAP_REPORT_DIR}:/zap/wrk" \
  "${ZAP_IMAGE}" \
  zap-baseline.py "${ZAP_BASELINE_ARGS[@]}" -t "${SCAN_TARGET}" -r zap-report.html -J zap-report.json -z "${ZAP_AUTH_CONFIG}"
