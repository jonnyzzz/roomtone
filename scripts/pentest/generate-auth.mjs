import crypto from "crypto";
import fs from "fs";
import path from "path";

const outDir = process.argv[2];
if (!outDir) {
  throw new Error("Usage: node scripts/pentest/generate-auth.mjs <output-dir>");
}

const { publicKey, privateKey } = crypto.generateKeyPairSync("rsa", {
  modulusLength: 2048
});
const publicPem = publicKey
  .export({ type: "spki", format: "pem" })
  .toString();
const privatePem = privateKey
  .export({ type: "pkcs8", format: "pem" })
  .toString();

const nowSeconds = Math.floor(Date.now() / 1000);
const payload = {
  exp: nowSeconds + 300,
  name: "Pentest User"
};
const header = { alg: "RS256", typ: "JWT" };

const base64Url = (input) =>
  Buffer.from(input)
    .toString("base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");

const signingInput = `${base64Url(JSON.stringify(header))}.${base64Url(
  JSON.stringify(payload)
)}`;
const signature = crypto.sign("RSA-SHA256", Buffer.from(signingInput), privatePem);
const token = `${signingInput}.${base64Url(signature)}`;

fs.mkdirSync(outDir, { recursive: true });
fs.writeFileSync(path.join(outDir, "public.pem"), publicPem);
fs.writeFileSync(path.join(outDir, "token.txt"), token);
