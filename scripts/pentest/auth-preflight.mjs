import fs from "fs";
import path from "path";

const baseUrl = process.argv[2];
const token = process.argv[3];
const outputPath = process.argv[4];

if (!baseUrl || !token) {
  throw new Error(
    "Usage: node scripts/pentest/auth-preflight.mjs <base-url> <token> [cookie-output]"
  );
}

async function fetchStatus(url, headers) {
  const response = await fetch(url, headers ? { headers } : undefined);
  return {
    status: response.status,
    text: await response.text(),
    headers: response.headers
  };
}

function findFirstAsset(html) {
  const match = html.match(/(?:src|href)=\"(\/assets\/[^\"\\s]+)\"/);
  return match ? match[1] : null;
}

function findAssetFromDisk() {
  const assetsDir = path.join(process.cwd(), "dist", "client", "assets");
  try {
    const entries = fs.readdirSync(assetsDir);
    const asset = entries.find((entry) => entry && !entry.startsWith("."));
    return asset ? `/assets/${asset}` : null;
  } catch {
    return null;
  }
}

const unauthRoot = await fetchStatus(baseUrl);
if (unauthRoot.status !== 401) {
  throw new Error(`Expected 401 for unauth root, got ${unauthRoot.status}.`);
}

const authHeader = { Authorization: `Bearer ${token}` };
const authedRoot = await fetchStatus(`${baseUrl}/`, authHeader);
if (authedRoot.status !== 200) {
  throw new Error(`Expected 200 for authed root, got ${authedRoot.status}.`);
}

const setCookie = authedRoot.headers?.get("set-cookie") ?? "";
const authCookie = setCookie.split(";")[0]?.trim() ?? "";
if (!authCookie) {
  throw new Error("Expected auth cookie to be set by server.");
}

const authedCookieRoot = await fetchStatus(baseUrl, { Cookie: authCookie });
if (authedCookieRoot.status !== 200) {
  throw new Error(
    `Expected 200 for cookie-auth root, got ${authedCookieRoot.status}.`
  );
}

const assetPath = findFirstAsset(authedRoot.text) ?? findAssetFromDisk();
if (!assetPath) {
  throw new Error("No asset reference found in HTML.");
}

const assetUrl = new URL(assetPath, baseUrl).toString();
const unauthAsset = await fetchStatus(assetUrl);
if (unauthAsset.status !== 401) {
  throw new Error(`Expected 401 for unauth asset, got ${unauthAsset.status}.`);
}

const authedAsset = await fetchStatus(assetUrl, { Cookie: authCookie });
if (authedAsset.status !== 200) {
  throw new Error(`Expected 200 for authed asset, got ${authedAsset.status}.`);
}

if (outputPath) {
  fs.writeFileSync(outputPath, authCookie, "utf8");
}
