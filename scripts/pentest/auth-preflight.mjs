const baseUrl = process.argv[2];
const token = process.argv[3];

if (!baseUrl || !token) {
  throw new Error(
    "Usage: node scripts/pentest/auth-preflight.mjs <base-url> <token>"
  );
}

async function fetchStatus(url) {
  const response = await fetch(url);
  return { status: response.status, text: await response.text() };
}

function findFirstAsset(html) {
  const match = html.match(/(?:src|href)=\"(\/assets\/[^\"\\s]+)\"/);
  return match ? match[1] : null;
}

const unauthRoot = await fetchStatus(baseUrl);
if (unauthRoot.status !== 401) {
  throw new Error(`Expected 401 for unauth root, got ${unauthRoot.status}.`);
}

const tokenParam = `token=${encodeURIComponent(token)}`;
const authedRoot = await fetchStatus(`${baseUrl}/?${tokenParam}`);
if (authedRoot.status !== 200) {
  throw new Error(`Expected 200 for authed root, got ${authedRoot.status}.`);
}

const assetPath = findFirstAsset(authedRoot.text);
if (!assetPath) {
  throw new Error("No asset reference found in HTML.");
}

const assetUrl = new URL(assetPath, baseUrl).toString();
const unauthAsset = await fetchStatus(assetUrl);
if (unauthAsset.status !== 401) {
  throw new Error(`Expected 401 for unauth asset, got ${unauthAsset.status}.`);
}

const separator = assetUrl.includes("?") ? "&" : "?";
const authedAsset = await fetchStatus(`${assetUrl}${separator}${tokenParam}`);
if (authedAsset.status !== 200) {
  throw new Error(`Expected 200 for authed asset, got ${authedAsset.status}.`);
}
